# 并行 Agent 执行 E2E 测试计划

## 测试目标

验证从任务匹配 → 3 Agent 并行执行 → 用户选择 → 验收支付的完整流程。

---

## 前置条件

### 1. 环境准备
- [ ] 开发服务器运行中 (`pnpm dev`)
- [ ] 本地 Supabase 运行中
- [ ] 数据库迁移已执行（executions 表存在）

### 2. 测试数据准备
- [ ] 至少 3 个已上架的 Agent（配置了 mastraUrl 和 mastraTokenId）
- [ ] 一个已连接钱包的用户（任务发布者）
- [ ] 一个已发布且已支付的任务（状态为 Standby）

---

## 测试用例

### TC-01: 自动匹配触发并行执行

**前置**: 任务状态为 Standby，有足够候选 Agent

**步骤**:
1. 打开任务详情页 `/tasks/{taskId}`
2. 确认订单状态显示"待匹配"
3. 点击"自动匹配"按钮
4. 等待 API 响应

**预期结果**:
- [ ] 返回 `result: 'executing'`
- [ ] 返回 `executions` 数组（1-3 个）
- [ ] 订单状态变为 `Executing`
- [ ] 页面显示 ExecutingActions 组件

---

### TC-02: D3.js 离子小球可视化

**前置**: 订单状态为 Executing

**步骤**:
1. 查看 ExecutionOrbs 组件渲染
2. 确认显示 1-3 个小球（三角形布局）
3. 观察执行中小球的脉动动画

**预期结果**:
- [ ] 小球正确显示（蓝色=执行中，绿色=已完成，红色=失败）
- [ ] 脉动动画正常（蓝色光环扩散）
- [ ] 小球显示 Agent 名称和状态文字

---

### TC-03: 小球拖拽交互

**前置**: ExecutionOrbs 组件已渲染

**步骤**:
1. 拖拽任意一个小球
2. 移动到其他位置
3. 松开鼠标

**预期结果**:
- [ ] 小球跟随鼠标移动
- [ ] 松开后小球弹性回弹到初始位置
- [ ] 拖拽过程中小球透明度降低

---

### TC-04: 点击小球弹出详情 Modal

**前置**: ExecutionOrbs 组件已渲染

**步骤**:
1. 点击任意一个小球
2. 查看弹出的 Modal

**预期结果**:
- [ ] Modal 正确弹出
- [ ] 显示 Agent 信息（名称、类型、评分、完成订单数）
- [ ] 显示执行状态 Badge
- [ ] 执行中状态显示 spinner 和 "正在执行中..."
- [ ] 显示关闭按钮

---

### TC-05: 执行完成后 Modal 显示结果

**前置**: 至少一个执行已完成

**步骤**:
1. 点击已完成（绿色）的小球
2. 查看 Modal 内容

**预期结果**:
- [ ] 显示"已完成"状态 Badge
- [ ] 显示执行结果预览（resultPreview）
- [ ] 显示完整结果内容（resultContent）
- [ ] 显示"选择此结果"按钮

---

### TC-06: 执行失败 Modal 显示错误

**前置**: 有执行失败的情况

**步骤**:
1. 点击失败（红色）的小球
2. 查看 Modal 内容

**预期结果**:
- [ ] 显示"失败"状态 Badge（红色）
- [ ] 显示错误信息（errorMessage）
- [ ] 不显示"选择此结果"按钮

---

### TC-07: 所有执行完成后进入选择阶段

**前置**: 所有执行都已完成（completed 或 failed）

**步骤**:
1. 等待所有执行完成
2. 观察页面状态变化

**预期结果**:
- [ ] 显示"所有 Agent 执行完成"提示
- [ ] 订单状态变为 `Selecting`
- [ ] 页面显示 SelectingActions 组件

---

### TC-08: 选择执行结果

**前置**: 订单状态为 Selecting

**步骤**:
1. 点击已完成的小球
2. 在 Modal 中点击"选择此结果"
3. 重复选择其他结果（最多 3 个）

**预期结果**:
- [ ] 选中的小球显示绿色边框高亮
- [ ] 底部显示"已选择: X / 3"
- [ ] 确认按钮显示"确认选择 (X)"
- [ ] 可以取消选择

---

### TC-09: 清空选择

**前置**: 已选择至少 1 个执行结果

**步骤**:
1. 点击"清空选择"按钮

**预期结果**:
- [ ] 所有选择被清空
- [ ] 已选择计数变为 0
- [ ] 小球高亮边框消失

---

### TC-10: 提交选择（选择 1-3 个）

**前置**: 已选择 1-3 个执行结果

**步骤**:
1. 点击"确认选择"按钮
2. 等待 API 响应

**预期结果**:
- [ ] 显示"提交中..."状态
- [ ] 选中的执行状态变为 `selected`
- [ ] 未选中的执行状态变为 `rejected`
- [ ] 订单状态变为 `InProgress`
- [ ] 页面刷新显示 InProgressStatus 组件

---

### TC-11: 放弃选择（选择 0 个）

**前置**: 未选择任何执行结果

**步骤**:
1. 确认选择数为 0
2. 点击"放弃并返回"按钮

**预期结果**:
- [ ] 所有执行状态变为 `rejected`
- [ ] 订单状态变为 `Standby`（返回待匹配）
- [ ] 页面刷新显示 StandbyActions 组件

---

### TC-12: 执行状态轮询

**前置**: 订单状态为 Executing，有执行中的任务

**步骤**:
1. 打开浏览器开发者工具 Network 标签
2. 观察 3 秒内的网络请求

**预期结果**:
- [ ] 每 3 秒发送一次 GET `/api/execution/order/{orderId}` 请求
- [ ] 请求包含 `x-user-id` header
- [ ] 执行完成后停止轮询

---

### TC-13: 交付流程（InProgress → Delivered）

**前置**: 订单状态为 InProgress

**步骤**:
1. 以 Provider（B 端）身份登录
2. 打开 B 工作台
3. 找到进行中的订单
4. 点击"交付"按钮
5. 填写交付内容并提交

**预期结果**:
- [ ] 订单状态变为 `Delivered`
- [ ] 显示交付时间
- [ ] A 端用户可以看到交付内容

---

### TC-14: 验收流程（Delivered → Accepted）

**前置**: 订单状态为 Delivered

**步骤**:
1. 以 Creator（A 端）身份登录
2. 打开任务详情页
3. 查看交付内容
4. 点击"验收"按钮

**预期结果**:
- [ ] 订单状态变为 `Accepted`
- [ ] 显示验收时间

---

### TC-15: 支付流程（Accepted → Paid → Completed）

**前置**: 订单状态为 Accepted

**步骤**:
1. 系统自动触发支付（或手动触发）
2. 等待链上交易确认

**预期结果**:
- [ ] 订单状态变为 `Paid`
- [ ] 显示支付交易哈希
- [ ] 最终状态变为 `Completed`

---

## 错误场景测试

### TC-E01: 候选 Agent 不足

**步骤**: 在只有 1-2 个 Agent 的情况下触发自动匹配

**预期结果**:
- [ ] 返回错误"候选 Agent 不足"
- [ ] 订单状态保持 Standby

---

### TC-E02: 所有 Agent Token 无效

**步骤**: 所有候选 Agent 的 Mastra Token 都无效

**预期结果**:
- [ ] 返回错误"没有有效 Mastra Token 的 Agent"
- [ ] 订单状态保持 Standby

---

### TC-E03: 网络错误

**步骤**: 在执行过程中断开网络

**预期结果**:
- [ ] 显示加载失败错误
- [ ] 提供重试选项

---

## 测试数据 SQL

```sql
-- 检查 Agent 数据
SELECT id, name, status, mastra_url, mastra_token_id, is_listed
FROM agents
WHERE is_listed = true
LIMIT 5;

-- 检查执行记录
SELECT e.*, a.name as agent_name
FROM executions e
LEFT JOIN agents a ON e.agent_id = a.id
ORDER BY e.created_at DESC
LIMIT 10;

-- 检查订单状态
SELECT id, status, execution_phase, agent_id
FROM orders
WHERE execution_phase IS NOT NULL;
```

---

## 测试执行记录

| 用例 | 执行时间 | 结果 | 备注 |
|------|----------|------|------|
| TC-01 | | | |
| TC-02 | | | |
| TC-03 | | | |
| TC-04 | | | |
| TC-05 | | | |
| TC-06 | | | |
| TC-07 | | | |
| TC-08 | | | |
| TC-09 | | | |
| TC-10 | | | |
| TC-11 | | | |
| TC-12 | | | |
| TC-13 | | | |
| TC-14 | | | |
| TC-15 | | | |
| TC-E01 | | | |
| TC-E02 | | | |
| TC-E03 | | | |
